---
title: Readable Code with Pipes
author: Aravind Hebbali
date: '2017-12-25'
slug: readable-code-with-pipes
categories:
  - data wrangling
tags:
  - pipes
  - magrittr
---

## Introduction

<hr>

When you are dealing with a sequence of multiple operations, R code can get a bit cramped and not so easy on the eyes. The [magrittr](https://CRAN.R-project.org/package=magrittr) package by [Stefan Milton Bache](http://stefanbache.dk/) provides pipes enabling us to write R code that is readable.

- especially useful when you have nested functions
- similar in spirit to javascript's method chaining
- functions taking multiple arguments can be confusing and messy to read
- with magrittr, you program from left to right

<br>

## Pipes

<hr>

R being a functional language, code contains a lot of parentheses. Complex code results in nested functions making them hard to read and maintain. If you are using [tidyverse](https://www.tidyverse.org/), magrittr will be automatically loaded. We will look at 3 different types of pipes:

- `%>%` : pipe a value forward into an expression or function call
- `%<>%`: result assigned to left hand side object instead of returning it 
- `%$%` : expose names within left hand side objects to right hand side expressions

<br>

## Libraries, Code & Data

<hr>

We will use the [magrittr](http://magrittr.tidyverse.org/), [readr](http://readr.tidyverse.org/) and [purrr](http://readr.tidyverse.org/) packages. You can find the data sets [here](https://github.com/rsquaredacademy/datasets) and the codes 
[here](https://gist.github.com/aravindhebbali/26d85ab4a4dadd2fe7c1f58d854cc950).


```{r importlib1, message=FALSE}
library(magrittr)
library(readr)
library(purrr)
```

<br>

## Data

<hr>

```{r show, message=FALSE}
ecom <- read_csv('https://raw.githubusercontent.com/rsquaredacademy/datasets/master/web.csv')
ecom
```

<br>

#### Data Dictionary

<hr>

- id: row id
- referrer: referrer website/search engine
- os: operating system
- browser: browser
- device: device used to visit the website
- n_pages: number of pages visited
- duration: time spent on the website (in seconds)
- repeat: frequency of visits
- country: country of origin
- purchase: whether visitor purchased
- order_value: order value of visitor (in dollars)

<br>

## First Example

<hr>

```{r mag1}
head(ecom, 10)
```

<br>

#### Using pipe

<hr>

```{r mag2}
ecom %>% head(10)
```

<br>

## Square Root 

<hr>

```{r mag3}
y <- ecom$n_pages
y <- sqrt(y)
head(y)
```

<br>

#### Square Root - Using pipe

<hr>

```{r mag4}
# select n_pages variable and assign it to y
y <- ecom %$% n_pages
head(y)

# compute square root of y and assign it to y 
y %<>% sqrt
head(y)
```

<br>

#### Square Root - Using pipe

<hr>

```{r mag5}
y <- ecom %$% 
  n_pages %>% 
  sqrt %>%
  head
y
```

<br>

## Correlation

<hr>

```{r mag6}
# without pipe
ecom1 <- subset(ecom, purchase == 'true')
cor(ecom1$n_pages, ecom1$duration)

# with pipe
ecom %>%
  subset(purchase == 'true') %$% 
  cor(n_pages, duration)
```

<br>

## Visualization

<hr>

```{r mag21, fig.align='center', fig.height=4, fig.width=6}
barplot(table(subset(ecom, purchase == 'true')$referrer))
```

<br>

## Visualization - Using pipe

<hr>

<center>
![](pipes_viz.png){width=60%}
</center>

<br>

```{r mag7, fig.align='center', fig.height=4, fig.width=6}
ecom %>%
  subset(purchase == 'true') %>%
  extract('referrer') %>%
  table %>%
  barplot
```

<br>

## Regression

<hr>

```{r mag8}
summary(lm(duration ~ n_pages, data = ecom))
```

<br>

## Regression - Using pipe

<hr>

```{r mag22}
ecom %$%
  lm(duration ~ n_pages) %>%
  summary
```

<br>

## String Manipulation

<hr>

```{r mag9}
email <- 'jovialcann@anymail.com'

# without pipe
toupper(strtrim(strsplit(email, '@')[[1]][1], 6))

# with pipe
email %>%
  strsplit(split = '@') %>%
  extract2(1) %>%
  extract(1) %>%
  strtrim(width = 6) %>%
  toupper
```

<br>

<center>
![](pipes_canva.png)
</center>

<br>

#### String Manipulation

<hr>

```{r map39}
email %>%
  strsplit(split = '@') %>%
  map_chr(1) %>%
  strtrim(width = 6) %>%
  toupper
```

<br>

## Data Extraction

<hr>

- `extract()`
- `extract2()`
- `use_series()`

<br>

#### Extract Column By Name

<hr>

```{r mag10}
head(ecom['n_pages'], 3)

ecom %>%
  extract('n_pages') %>%
  head(3)
```

<br>

#### Extract Column By Position

<hr>

```{r mag23}
head(ecom[6], 3)

ecom %>%
  extract(6) %>%
  head(3)
```

<br>

#### Extract Column (as vector)

<hr>

```{r mag11}
head(ecom$n_pages)

ecom %>%
  use_series('n_pages') %>%
  head()
```

<br>

#### Extract List Element By Name

<hr>

```{r mag12}
mt <- as.list(mtcars)

mt[['mpg']]

mt %>%
  extract2('mpg')
```

<br>

#### Extract List Element By Position

<hr>

```{r mag13}
mt <- as.list(mtcars)

mt[[1]]

mt %>%
  extract2(1)
```

<br>

#### Extract List Element (as vector)

<hr>

```{r mag14}
mt <- as.list(mtcars)

mt$mpg

mt %>%
  use_series(mpg)
```

<br>

## Arithmetic Operations

<hr>

- `add()`
- `subtract()`
- `multiply_by()`
- `multiply_by_matrix()`
- `divide_by()`
- `divide_by_int()`
- `mod()`
- `raise_to_power()`

<br>

#### Addition

<hr>

```{r mag15}
1:10 %>%
  `+`(1)

1:10 %>%
  add(1)
```

<br>

#### Multiplication

<hr>

```{r mag16}
1:10 %>%
  `*`(3)

1:10 %>%
  multiply_by(3)
```

<br>

#### Division

<hr>

```{r mag17}
1:10 %>%
  `/`(2)

1:10 %>%
  divide_by(2)
```

<br>

#### Power

<hr>

```{r mag18}
1:10 %>%
  `^`(2)

1:10 %>%
  raise_to_power(2)
```

<br>

## Logical Operators

<hr>

- `and()`
- `or()`
- `equals()`
- `not()`
- `is_greater_than()`
- `is_weakly_greater_than()`
- `is_less_than()`
- `is_weakly_less_than()`

<br>

#### Greater Than

<hr>

```{r mag19}
1:10 %>%
  `>`(5)

1:10 %>%
  is_greater_than(5)
```

<br>

#### Weakly Greater Than

<hr>

```{r mag20}
1:10 %>%
  `>=`(5)

1:10 %>%
  is_weakly_greater_than(5)
```
