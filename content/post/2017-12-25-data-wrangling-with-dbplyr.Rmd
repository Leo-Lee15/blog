---
title: Data Wrangling with dbplyr
date: '2017-12-25'
slug: data-wrangling-with-dbplyr
categories:
  - database
  - data-wrangling
tags:
  - dbplyr
  - dplyr
---

### Introduction

This is the third post in the series **R & Databases**. You can find the links to the other two posts of this series below:

- [Quick Guide: R & SQLite](https://rsquaredacademy.github.io/blog/post/quick-guide-r-sqlite/)
- [SQL for Data Science - Part 1](https://rsquaredacademy.github.io/blog/post/sql-for-data-science-part-1 )
- [SQL for Data Science - Part 2](https://rsquaredacademy.github.io/blog/post/sql-for-data-science-part-2)

In this post, we will learn to query data from a database using dplyr.

### Libraries, Code & Data

We will use the following libraries in this post:

- [DBI](http://readr.tidyverse.org/)
- [RSQLite](https://rstats-db.github.io/RSQLite/)
- [dbplyr](http://dbplyr.tidyverse.org/)
- [dplyr](http://dplyr.tidyverse.org/)

All the data sets used in this post can be found [here](https://github.com/rsquaredacademy/datasets) and code can be downloaded from [here](https://gist.github.com/rsquaredacademy/f5ee72cee9ab3256230cdedecd3ef25b).


```{r lite1, echo=FALSE, eval=TRUE, results='hide', message=FALSE}
library(dbplyr)
library(dplyr)
library(DBI)
library(RSQLite)
```

#### Connect to Database

Let us connect to an in memory SQLite database using `dbConnect()`.

```{r dbply1}
con <- dbConnect(RSQLite::SQLite(), ":memory:")
```

We will copy the `mtcars` data to the database so that we can use it for running
dplyr statements.

```{r dbply2}
copy_to(con, mtcars)
```

#### Reference Copied Data Frame

In order to use dplyr functions, we need to reference the table in the database using
`tbl()`.

```{r dbply3}
mtcars2 <- tbl(con, "mtcars")
mtcars2
```

#### Query Data 

Let us start by selecting some columns from the referenced table.

```{r dbply4}
select(mtcars2, mpg, cyl, drat)
```

Try filtering data.

```{r dbply5}
filter(mtcars2, mpg > 25)
```

Time to do some grouping and summarizing.

```{r dbply6}
mtcars2 %>%
  group_by(cyl) %>%
  summarise(mileage = mean(mpg))
```

#### Show Query

If you want to view the SQL query generated from the dplyr statements, use `show_query()`.

```{r dbply7, collapse=TRUE}
mileages <- 
  mtcars2 %>%
  group_by(cyl) %>%
  summarise(mileage = mean(mpg))

show_query(mileages)
```

#### Collect Data

Now, some interesting facts. **dbplyr** does not read/import data until we ask it to do so.
Use `collect()` to actually run the SQL statements.

```{r dbply9}
collect(mileages)
```

### Up Next..

In the next [post](https://rsquaredacademy.github.io/blog/post/sql-for-data-science-part-1), we will learn basic SQL commands.

